"use strict";(self.webpackChunksc_utility=self.webpackChunksc_utility||[]).push([[7357],{87072:(e,t,r)=>{function n(e){var t;const r=e.layer;return"floorInfo"in r&&null!==(t=r.floorInfo)&&void 0!==t&&t.floorField&&"floors"in e.view?l(e.view.floors,r.floorInfo.floorField):null}function i(e,t){var r;return"floorInfo"in t&&null!==(r=t.floorInfo)&&void 0!==r&&r.floorField?l(e,t.floorInfo.floorField):null}function l(e,t){if(null===e||void 0===e||!e.length)return null;const r=e.filter((e=>""!==e)).map((e=>"'".concat(e,"'")));return r.push("''"),"".concat(t," IN (").concat(r.join(","),") OR ").concat(t," IS NULL")}r.d(t,{c:()=>n,f:()=>i})},27357:(e,t,r)=>{r.d(t,{FeatureSnappingEngine:()=>G});var n=r(27366),i=r(7138),l=r(63780),a=r(42537),o=r(93169),s=r(66978),u=r(94172),d=r(68860),c=r(49861),p=r(32718),v=r(69912),h=r(13611),y=r(32035),f=r(12400),g=r(24204),S=r(46634),_=r(74509),b=r(44179),w=r(38054),m=r(76672),F=(r(84936),r(18661)),R=r(87072),C=r(37933),I=r(64674),x=r(69787);let E=class extends i.Z{set attributeRulesEnabled(e){this._set("attributeRulesEnabled",e),e&&this.loadRules()}get layerView(){var e;return null===(e=this.view)||void 0===e||null===(e=e.allLayerViews)||void 0===e?void 0:e.find((e=>e.layer===this.layer))}get valid(){const{_valid:e,snappingSource:t,layer:r}=this;return!(!t||!r)&&e}get subtypeFilter(){var e,t,r;const{layer:n,snappingSource:i}=this;if(!(0,C.e9)(n)||null===(e=n.subtypes)||void 0===e||!e.length||!i)return{mode:"not-in-use",filter:null};const l=i.layerSource.sublayerSources.filter((e=>{var t;return e.enabled&&e.layer.visible&&(0,x.rs)(null===(t=this.view)||void 0===t?void 0:t.scale,e.layer.effectiveScaleRange.minScale,e.layer.effectiveScaleRange.maxScale)})).map((e=>e.layer.subtypeCode));if(!l.length)return{mode:"none-visible",filter:null};if(l.length===n.subtypes.length)return{mode:"all-visible",filter:null};const a=null!==(t=null===(r=n.fieldsIndex.get(n.subtypeField))||void 0===r?void 0:r.name)&&void 0!==t?t:n.subtypeField;return 1===l.length?{mode:"in-use",filter:"".concat(a," = ").concat(l.getItemAt(0))}:{mode:"in-use",filter:"".concat(a," IN (").concat(l.join(", "),")")}}get floorFilter(){const{view:e,layer:t}=this;return e&&t?(0,R.c)({view:e,layer:t}):null}constructor(e){super(e),this.layer=null,this.snappingSource=null,this.rulesTable=null,this._valid=null}initialize(){if(!this.snappingSource||!this.layer)return void(this._valid=!1);const{layer:e,snappingSource:t}=this;if("refresh"in e){const r=e;this.addHandles(r.on("refresh",(()=>t.refresh())))}this.loadRules(),this.addHandles([(0,u.YP)((()=>t.updating),(e=>t.layerSource.updating=e),u.tX),(0,u.YP)((()=>t.availability),(e=>t.layerSource.availability=e),u.tX)])}getFetchCandidatesParameters(e,t,r){var n,i,l,a,s;if(!this.valid)return[];const{layer:u,layerView:d,floorFilter:c,rulesTable:p,subtypeFilter:v}=this,h={distance:r,mode:null!==(n=null===(i=this.view)||void 0===i?void 0:i.type)&&void 0!==n?n:"2d",point:e,coordinateHelper:t.coordinateHelper,returnEdge:!0,vertexMode:"all",filter:d&&"filter"in d?d.filter:null};if(c&&(h.filter=L(h.filter,c)),"not-in-use"!==v.mode&&"all-visible"!==v.mode){if("none-visible"===v.mode)return[];h.filter?h.filter.where=(0,m._)(h.filter.where,v.mode):h.filter=new F.Z({where:v.filter})}if(!this.attributeRulesEnabled)return[h];const y=t.feature,f="subtype-sublayer"===(null===y||void 0===y||null===(l=y.sourceLayer)||void 0===l?void 0:l.type)?y.sourceLayer.parent:null===y||void 0===y?void 0:y.sourceLayer;if(p&&y&&(0,I.n0)(null===(a=this.view)||void 0===a?void 0:a.map)&&((0,C.Te)(u)||(0,C.e9)(u))&&u.layerId&&((0,C.Te)(f)||(0,C.e9)(f))&&null!==(s=this.view.map.utilityNetworks)&&void 0!==s&&s.find((e=>e.isUtilityLayer(f)))){var g,S;if("loaded"!==p.loadStatus)return[];const e=[],t=u.layerId,r=null===(g=p.getFeatureSQL(f,y))||void 0===g?void 0:g[t];if(!r)return[];const n=r.anyVertex;let i=r.endVertex;return i&&n&&i===n&&(i=""),i&&e.push({...h,returnEdge:!1,vertexMode:"ends",filter:L(h.filter,i)}),n&&e.push({...h,returnEdge:null!==(S=(0,o.Z)("snapping-include-edges-when-applying-any-vertex-rule"))&&void 0!==S&&S,vertexMode:"all",filter:L(h.filter,n)}),e}return[h]}async loadRules(){this._valid=null;const{layer:e,view:t,attributeRulesEnabled:r}=this;if(r&&e&&t&&(0,I.n0)(null===t||void 0===t?void 0:t.map)&&((0,C.Te)(e)||(0,C.e9)(e)))try{var n,i,l,a;await Promise.allSettled(null!==(n=null===(i=t.map.utilityNetworks)||void 0===i?void 0:i.map((e=>e.load())))&&void 0!==n?n:[]);const r=null===(l=t.map.utilityNetworks)||void 0===l?void 0:l.find((t=>t.isUtilityLayer(e)));r&&(this.rulesTable=await r.getRulesTable(),await(null===(a=this.rulesTable)||void 0===a?void 0:a.load()))}catch(o){return this._valid=!1,void p.Z.getLogger("esri.views.interactive.snapping.FeatureSnappingSourceInfo").error("Failed to load rules table for snapping source",e.title)}this._valid=!0}remove(){this.destroy()}destroy(){var e;null===(e=this.snappingSource)||void 0===e||e.destroy()}};function L(e,t){return null==e?new F.Z({where:t}):e.where?new F.Z({where:(0,m._)(e.where,t)}):new F.Z({where:t})}(0,n._)([(0,c.Cb)({constructOnly:!0})],E.prototype,"layer",void 0),(0,n._)([(0,c.Cb)({constructOnly:!0})],E.prototype,"snappingSource",void 0),(0,n._)([(0,c.Cb)({constructOnly:!0})],E.prototype,"view",void 0),(0,n._)([(0,c.Cb)({value:!1})],E.prototype,"attributeRulesEnabled",null),(0,n._)([(0,c.Cb)()],E.prototype,"layerView",null),(0,n._)([(0,c.Cb)()],E.prototype,"rulesTable",void 0),(0,n._)([(0,c.Cb)()],E.prototype,"valid",null),(0,n._)([(0,c.Cb)()],E.prototype,"subtypeFilter",null),(0,n._)([(0,c.Cb)()],E.prototype,"floorFilter",null),(0,n._)([(0,c.Cb)()],E.prototype,"_valid",void 0),E=(0,n._)([(0,v.j)("esri.views.interactive.snapping.FeatureSnappingSourceInfo")],E);var M=r(80371),T=r(97760),P=r(95905),j=r(75691),H=r(19824),O=r(11208);let G=class extends i.Z{get updating(){return this._snappingSources.some((e=>{var t;return null==(null===e||void 0===e?void 0:e.valid)||!0===e.valid&&!0===(null===(t=e.snappingSource)||void 0===t?void 0:t.updating)}))||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=M.B.FEATURE,this._updatingHandles=new S.R,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){const e=(0,u.TP)((()=>{var e;return null===(e=this.options)||void 0===e?void 0:e._effectiveFeatureSources}),((e,t)=>this._createSourceInfo(e,t)));this._snappingSources=e,this.addHandles([(0,a.ed)(e),(0,u.YP)((()=>{var e;return{rulesEnabled:!(null===(e=this.options)||void 0===e||!e.attributeRulesEnabled),sources:this._snappingSources.filter(l.pC)}}),(e=>{let{rulesEnabled:t,sources:r}=e;for(const n of r)n.attributeRulesEnabled=t}),u.Z_)])}destroy(){this._set("options",null),this._updatingHandles.destroy()}async fetchCandidates(e,t,r,n){if(!(t&this._domain&&null!=this.options&&this.options.effectiveFeatureEnabled))return[];const i=[],l=this._computeScreenSizeDistanceParameters(e,r);for(const s of this._snappingSources){var a,o;if(null===s||void 0===s||!s.valid||null===(a=s.snappingSource)||void 0===a||null===(a=a.layerSource)||void 0===a||!a.enabled||null!==(o=s.layerView)&&void 0!==o&&o.suspended)continue;const t=s.getFetchCandidatesParameters(e,r,l);for(const e of t)i.push(s.snappingSource.fetchCandidates(e,n).then((e=>e.filter((e=>!this._candidateIsExcluded(s.snappingSource,e,r.excludeFeature))))))}const u=(await(0,s.OT)(i)).flat();return this._addRightAngleCandidates(u,e,l,r),(0,s.k_)(n),(0,I.lQ)(e,u),u}_addRightAngleCandidates(e,t,r,n){var i,l,a,o;const s=null!=n.vertexHandle?null===(i=n.vertexHandle.rightEdge)||void 0===i||null===(i=i.rightVertex)||void 0===i?void 0:i.pos:null!=n.editGeometryOperations&&"polygon"===n.editGeometryOperations.data.type?null===(l=n.editGeometryOperations.data.components[0])||void 0===l||null===(l=l.getFirstVertex())||void 0===l?void 0:l.pos:null,u=null!=n.vertexHandle?null===(a=n.vertexHandle.leftEdge)||void 0===a||null===(a=a.leftVertex)||void 0===a?void 0:a.pos:null!=n.editGeometryOperations?null===(o=n.editGeometryOperations.data.components[0])||void 0===o||null===(o=o.getLastVertex())||void 0===o?void 0:o.pos:null,{view:d}=this,c=(0,w.j7)(s,d,n),p=(0,w.j7)(u,d,n),v=e.length;for(let h=0;h<v;h++)this._addRightAngleCandidate(e[h],p,t,r,e),this._addRightAngleCandidate(e[h],c,t,r,e)}_addRightAngleCandidate(e,t,r,n,i){if(null==t||!function(e){return(e instanceof P.L||e instanceof T.k)&&!function(e){let{constraint:{start:t,end:r}}=e;const n=(0,y.s)(t,r),i=(0,h.bI)((0,w.eR)(t),(0,w.eR)(r));return n<(0,g.bn)()||i/n<z}(e)}(e))return;const l=e.constraint.closestTo(t),a=(l[0]-r[0])/n.x,o=(l[1]-r[1])/n.y,{start:s,end:u}=e.constraint;if(a*a+o*o<=1){const r=(0,h.bI)((0,w.eR)(l),(0,w.eR)(s))>(0,h.bI)((0,w.eR)(l),(0,w.eR)(u))?s:u,n=new H.A1({targetPoint:(0,w.s)(l),otherVertex:t,otherVertexType:H.YJ.NEXT,previousVertex:r,constraint:new b.aU(t,l),objectId:e.objectId,isDraped:e.isDraped,domain:M.B.FEATURE});i.push(n)}}_computeScreenSizeDistanceParameters(e,t){let r=null!=this.options?this.options.distance*("touch"===t.pointer?this.options.touchSensitivityMultiplier:1):0;return null==this.view?{x:r,y:r,z:r,distance:r}:"2d"===this.view.type?(r*=this.view.resolution,{x:r,y:r,z:r,distance:r}):this._computeScreenSizeDistanceParameters3D(e,r,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,r,n){const{spatialReference:i}=n;r.renderCoordsHelper.toRenderCoords(e,i,k);const l=r.state.camera.computeScreenPixelSizeAt(k),a=l*r.renderCoordsHelper.unitInMeters,o=a/(0,d.c9)(i),s=a/(0,d._R)(i),u=t*o,c=t*s,p=(0,O.R)(e,i,_.jG,r),v=p?V(p,e,o,0,0,r,n):0,h=p?V(p,e,0,o,0,r,n):0,y=p?V(p,e,0,0,s,r,n):0;return{x:0===v?0:u/v,y:0===h?0:u/h,z:0===y?0:c/y,distance:l*t}}_candidateIsExcluded(e,t,r){if(null==r)return!1;const n=this._getCandidateObjectId(t);if(null==n)return!1;const i=e.layerSource.layer;return"graphics"===i.type?r.uid===n:r.sourceLayer===i&&!(!r.attributes||!("objectIdField"in i))&&r.attributes[i.objectIdField]===n}_getCandidateObjectId(e){return e instanceof j.a?e.objectId:null}async _createSourceInfo(e,t){const r=e.layer;r.loaded||(await r.load(),(0,s.k_)(t));const{view:n}=this,i=await this._createFeatureSnappingSourceType(e);return(0,s.k_)(t),new E(null==i?{}:{snappingSource:i,view:n,layer:r})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;return null==t||"3d"!==t.type?null:new((await this._getSourceModule("scene")).SceneLayerSnappingSource)({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){var t;switch(null===(t=e.layer.source)||void 0===t?void 0:t.type){case"feature-layer":case"oriented-imagery":return new((await this._getSourceModule("featureService")).FeatureServiceSnappingSource)({spatialReference:this.spatialReference,view:this.view,layerSource:e});case"memory":case"csv":case"geojson":case"wfs":return"mesh"===e.layer.geometryType?null:new((await this._getSourceModule("featureCollection")).FeatureCollectionSnappingSource)({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new((await this._getSourceModule("graphics")).GraphicsSnappingSource)({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new((await this._getSourceModule("notes")).GraphicsSnappingSource)({getGraphicsLayers:()=>{var t,r;return null!==(t=null===(r=e.layer.sublayers)||void 0===r?void 0:r.toArray())&&void 0!==t?t:[]},spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){const t=this._sourceModules[e];if(null==t.loader){const t=this._loadSourceModule(e),r={module:null,loader:t};this._sourceModules[e]=r;const n=await t,i={module:n,loader:t};return this._sourceModules[e]=i,n}return null==t.module?t.loader:t.module}_loadSourceModule(e){const t=this._updatingHandles;switch(e){case"featureService":return t.addPromise(r.e(5532).then(r.bind(r,5532)));case"featureCollection":return t.addPromise(r.e(2137).then(r.bind(r,26823)));case"graphics":case"notes":return t.addPromise(Promise.all([r.e(5026),r.e(9434),r.e(1486),r.e(8522),r.e(4579),r.e(3518)]).then(r.bind(r,33518)));case"scene":return t.addPromise(r.e(2767).then(r.bind(r,92767)))}}get test(){}};function V(e,t,r,n,i,l,a){let{spatialReference:o}=a;const s=(0,y.c)(A,t);s[0]+=r,s[1]+=n,s[2]+=i;const u=(0,O.R)(s,o,_.jG,l);return u?(0,I.fG)(u,e):1/0}(0,n._)([(0,c.Cb)({constructOnly:!0})],G.prototype,"spatialReference",void 0),(0,n._)([(0,c.Cb)({constructOnly:!0})],G.prototype,"view",void 0),(0,n._)([(0,c.Cb)()],G.prototype,"options",void 0),(0,n._)([(0,c.Cb)({readOnly:!0})],G.prototype,"updating",null),(0,n._)([(0,c.Cb)()],G.prototype,"_snappingSources",void 0),G=(0,n._)([(0,v.j)("esri.views.interactive.snapping.FeatureSnappingEngine")],G);const k=(0,f.Ue)(),A=(0,f.Ue)(),z=1e-4}}]);
//# sourceMappingURL=7357.439ed4e1.chunk.js.map